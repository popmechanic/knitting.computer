<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>The Knitting Computer</title>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <style>
      :root {
        /* Core colors */
        --vibes-black: #0f172a;
        --vibes-white: #ffffff;
        --vibes-near-black: #1a1a1a;
        --vibes-cream: #fffff0;

        /* Gray scale */
        --vibes-gray-lightest: #f1f5f9;
        --vibes-gray-ultralight: #f8fafc;

        /* Menu colors */
        --vibes-menu-bg: #CCCDC8;
        --vibes-menu-grid: rgba(255, 255, 255, 0.5);

        /* Button variant colors */
        --vibes-variant-blue: #009ACE;
        --vibes-variant-red: #DA291C;
        --vibes-variant-yellow: #DA291C;
        --vibes-variant-gray: #6b7280;

        /* Button styling */
        --vibes-button-bg: var(--vibes-cream);
        --vibes-button-text: var(--vibes-near-black);
        --vibes-button-border: var(--vibes-near-black);
        --vibes-button-icon-bg: #fff;
        --vibes-button-icon-fill: #2a2a2a;
      }
      body {
        margin: 0;
        padding: 0;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      }
      #container {
        width: 100%;
        height: 100vh;
      }
    </style>
  </head>
  <body>
    <div id="container"></div>
    <script type="importmap">
      {
        "imports": {
          "react": "https://esm.sh/react@18.3.1",
          "react-dom": "https://esm.sh/react-dom@18.3.1?deps=react@18.3.1",
          "react-dom/client": "https://esm.sh/react-dom@18.3.1/client?deps=react@18.3.1",
          "react/jsx-runtime": "https://esm.sh/react@18.3.1/jsx-runtime",
          "use-fireproof": "https://esm.sh/use-fireproof@0.20.0-dev-preview-50?deps=react@18.3.1",
          "use-vibes": "https://esm.sh/use-vibes@0.18.9?deps=react@18.3.1",
          "@clerk/clerk-react": "https://esm.sh/@clerk/clerk-react@5?deps=react@18.3.1,react-dom@18.3.1"
        }
      }
    </script>
    <!-- Load React globally for menu components -->
    <script type="module">
      import * as React from "react";
      window.React = React;

      // === VibesSwitch ===
      const switchColors = { primary: "var(--vibes-black)", secondary: "var(--vibes-white)" };
      function VibesSwitch({ size = 24, className, isActive, onToggle }) {
        const [internalActive, setInternalActive] = React.useState(true);
        const logicalActive = isActive !== undefined ? isActive : internalActive;
        const active = !logicalActive;
        const handlePointerDown = (e) => {
          e.stopPropagation();
          e.preventDefault();
          const newState = !logicalActive;
          if (onToggle) onToggle(newState);
          if (isActive === undefined) setInternalActive(newState);
        };
        const originalD = "M426.866,285.985c-7.999-0.416-19.597-0.733-31.141-1.687c-15.692-1.297-28.809-8.481-40.105-19.104c-12.77-12.008-20.478-26.828-22.714-44.177c-3.048-23.644,3.384-44.558,19.646-62.143c9.174-9.92,20.248-17.25,33.444-20.363c7.786-1.837,15.944-2.399,23.973-2.828c9.988-0.535,20.023-0.666,30.021-0.371c10.191,0.301,20.433,0.806,30.521,2.175c12.493,1.696,23.132,7.919,32.552,16.091c14.221,12.337,22.777,27.953,25.184,46.594c2.822,21.859-2.605,41.617-16.777,58.695c-9.494,11.441-21.349,19.648-35.722,23.502c-6.656,1.785-13.724,2.278-20.647,2.77C446.914,285.721,438.682,285.667,426.866,285.985z";
        const stretchedD = "M165.866,285.985c-7.999-0.416-19.597-0.733-31.141-1.687c-15.692-1.297-28.809-8.481-40.105-19.104c-12.77-12.008-20.478-26.828-22.714-44.177c-3.048-23.644,3.384-44.558,19.646-62.143c9.174-9.92,20.248-17.25,33.444-20.363c7.786-1.837,15.944-2.399,23.973-2.828c9.988-0.535,121.023-0.666,131.021-0.371c10.191,0.301,20.433,0.806,30.521,2.175c12.493,1.696,23.132,7.919,32.552,16.091c14.221,12.337,22.777,27.953,25.184,46.594c2.822,21.859-2.605,41.617-16.777,58.695c-9.494,11.441-21.349,19.648-35.722,23.502c-6.656,1.785-13.724,2.278-20.647,2.77C286.914,285.721,177.682,285.667,165.866,285.985z";
        return React.createElement("svg", { xmlns: "http://www.w3.org/2000/svg", height: size, viewBox: "0 0 600 300", fill: "currentColor", className, onPointerDown: handlePointerDown },
          React.createElement("path", { fillRule: "evenodd", clipRule: "evenodd", fill: "#000", d: "M293.353,298.09c-41.038,0-82.078,0.125-123.115-0.077c-11.993-0.06-24.011-0.701-35.964-1.703c-15.871-1.331-29.73-7.937-41.948-17.946c-16.769-13.736-27.207-31.417-30.983-52.7c-4.424-24.93,1.404-47.685,16.506-67.913c11.502-15.407,26.564-26.1,45.258-30.884c7.615-1.949,15.631-2.91,23.501-3.165c20.08-0.652,40.179-0.853,60.271-0.879c69.503-0.094,139.007-0.106,208.51,0.02c14.765,0.026,29.583,0.097,44.28,1.313c36.984,3.059,61.78,23.095,74.653,57.301c17.011,45.199-8.414,96.835-54.29,111.864c-7.919,2.595-16.165,3.721-24.434,3.871c-25.614,0.467-51.234,0.742-76.853,0.867C350.282,298.197,321.817,298.09,293.353,298.09z" }),
          React.createElement("path", { fill: "#fff", fillRule: "evenodd", clipRule: "evenodd", d: active ? stretchedD : originalD, style: { transition: "d 0.3s ease, transform 0.8s ease", transform: active ? "translateX(3px)" : "none" } }),
          React.createElement("path", { fillRule: "evenodd", clipRule: "evenodd", style: { transition: "fill 0.5s ease", fill: active ? switchColors.primary : switchColors.secondary }, d: "M181.891,205.861c0-5.043-0.001-10.086,0-15.129c0.001-5.046,1.679-7.539,6.606-7.695c9.292-0.294,18.653-1.051,27.888,0.707c7.614,1.449,11.523,5.954,11.902,13.446c0.066,1.312-0.313,2.752-0.857,3.966c-1.401,3.123-1.399,6.266-0.673,9.507c0.301,1.342,0.443,2.723,0.787,4.053c1.274,4.925-1.78,10.114-6.085,11.937c-3.111,1.318-6.561,2.327-9.909,2.497c-7.303,0.37-14.639,0.136-21.96,0.101c-1.165-0.005-2.345-0.181-3.488-0.422c-2.657-0.56-4.162-2.962-4.197-6.801C181.854,216.639,181.891,211.25,181.891,205.861z M204.442,192.385c-2.757,0-5.514,0-8.271,0c-3.695,0-5.151,1.669-4.712,5.403c0.369,3.14,1.05,3.735,4.225,3.737c5.024,0.004,10.05,0.109,15.07-0.014c2.028-0.05,4.167-0.27,6.04-0.98c3.182-1.207,3.639-4.256,1.008-6.455c-1.073-0.896-2.659-1.509-4.06-1.618C210.659,192.22,207.544,192.385,204.442,192.385z M204.334,211.104c0,0.045,0,0.091,0,0.137c-3.101,0-6.203-0.055-9.302,0.037c-0.823,0.024-2.257,0.373-2.344,0.794c-0.447,2.154-0.959,4.444-0.639,6.563c0.276,1.822,2.447,1.451,3.882,1.441c5.989-0.042,11.98-0.118,17.961-0.385c1.416-0.063,2.859-0.79,4.176-1.441c1.79-0.886,1.833-2.475,1.029-4.046c-1.166-2.276-3.297-3.024-5.677-3.081C210.394,211.049,207.363,211.104,204.334,211.104z" }),
          React.createElement("path", { fillRule: "evenodd", clipRule: "evenodd", style: { transition: "fill 0.8s ease", fill: active ? switchColors.primary : switchColors.secondary }, d: "M291.409,229.748c-3.621-0.394-7.838-0.587-11.94-1.379c-3.577-0.69-6.343-2.991-8.213-6.163c-1.763-2.99-0.301-5.6,3.139-5.292c2.287,0.205,4.512,1.129,6.758,1.755c6.281,1.751,12.643,1.892,19.053,0.951c0.667-0.098,1.31-0.416,1.941-0.686c1.502-0.644,2.55-1.682,2.581-3.415c0.031-1.74-1.195-2.749-2.579-3.132c-2.298-0.637-4.688-1.021-7.065-1.273c-5.062-0.536-10.252-0.401-15.187-1.475c-9.677-2.105-11.678-10.53-10.101-16.009c1.62-5.625,5.911-8.92,11.318-9.73c8.388-1.257,16.925-1.491,25.279,0.654c3.702,0.951,6.615,3.072,7.883,6.931c0.918,2.792-0.332,4.6-3.268,4.357c-1.684-0.139-3.367-0.676-4.974-1.248c-6.711-2.387-13.572-2.897-20.569-1.783c-1.001,0.159-2.146,0.414-2.875,1.034c-0.901,0.766-2.016,1.981-1.98,2.964c0.041,1.128,0.995,2.733,1.991,3.206c1.81,0.857,3.925,1.279,5.948,1.441c5.152,0.41,10.356,0.296,15.479,0.905c7.98,0.949,13.779,9.833,11.241,17.125c-1.959,5.628-6.44,8.489-12.143,9.322C299.455,229.344,295.715,229.419,291.409,229.748z" }),
          React.createElement("path", { fillRule: "evenodd", clipRule: "evenodd", style: { transition: "fill 1.2s ease", fill: active ? switchColors.primary : switchColors.secondary }, d: "M235.786,208.14c0-6.905-0.01-13.809,0.004-20.714c0.007-3.474,0.948-4.428,4.415-3.758c6.62,1.279,13.232,2.651,19.759,4.331c1.7,0.438,3.404,1.896,4.515,3.341c1.777,2.31,0.433,5.367-2.463,5.745c-1.86,0.243-3.819-0.138-5.717-0.368c-2.183-0.264-4.339-0.783-6.525-0.976c-1.572-0.138-3.065,0.375-3.8,1.959c-0.76,1.638-0.319,3.329,0.942,4.34c1.619,1.296,3.522,2.327,5.447,3.128c2.146,0.894,4.539,1.207,6.66,2.145c1.446,0.64,2.982,1.687,3.786,2.981c0.689,1.11,0.928,3.094,0.378,4.202c-0.492,0.991-2.32,1.795-3.579,1.825c-2.238,0.052-4.483-0.652-6.741-0.832c-1.614-0.127-3.333-0.203-4.865,0.212c-2.574,0.699-3.225,3.013-1.719,5.218c1.396,2.044,3.431,3.141,5.757,3.761c2.791,0.744,5.637,1.315,8.373,2.222c3.19,1.058,4.791,3.496,4.801,6.723c0.011,3.365-1.759,5.021-5.138,4.424c-4.402-0.778-8.759-1.81-13.134-2.735c-2.357-0.499-4.718-0.981-7.069-1.511c-3.263-0.737-4.132-1.805-4.141-5.154c-0.019-6.836-0.006-13.672-0.006-20.508C235.747,208.141,235.766,208.14,235.786,208.14z" }),
          React.createElement("path", { fillRule: "evenodd", clipRule: "evenodd", style: { transition: "fill 0.6s ease", fill: active ? switchColors.primary : switchColors.secondary }, d: "M135.138,229.842c-2.941-0.084-5.296-1.462-6.684-3.9c-1.827-3.21-3.328-6.618-4.81-10.011c-3.55-8.128-7.021-16.291-10.486-24.455c-0.48-1.132-0.902-2.329-1.087-3.536c-0.417-2.72,1.238-4.585,3.938-4.119c1.591,0.275,3.569,0.98,4.45,2.173c2.226,3.015,4.175,6.299,5.784,9.69c2.208,4.654,3.898,9.552,6.032,14.244c0.628,1.379,2.009,2.416,3.045,3.609c0.892-1.159,2.042-2.201,2.63-3.498c2.697-5.953,5.22-11.985,7.841-17.974c1.423-3.252,3.089-6.418,6.532-7.905c1.238-0.535,3.012-0.712,4.184-0.214c0.81,0.344,1.377,2.126,1.385,3.271c0.009,1.458-0.479,2.997-1.059,4.371c-4.227,10.013-8.504,20.005-12.833,29.974c-0.79,1.819-1.762,3.589-2.875,5.229C139.73,228.848,137.671,229.894,135.138,229.842z" }),
          React.createElement("path", { fillRule: "evenodd", clipRule: "evenodd", style: { transition: "fill 1.3s ease", fill: active ? switchColors.primary : switchColors.secondary }, d: "M164.636,206.263c0-6.691,0.054-13.383-0.036-20.073c-0.024-1.851,0.716-2.67,2.449-2.81c0.274-0.022,0.549-0.054,0.823-0.076c5.488-0.445,6.091,0.105,6.091,5.562c0,12.348,0,24.695,0,37.043c0,2.887-0.354,3.405-3.222,3.618c-1.628,0.121-3.338-0.001-4.91-0.408c-0.593-0.153-1.265-1.408-1.278-2.171c-0.096-5.584-0.034-11.172-0.022-16.759c0.002-1.308,0-2.617,0-3.926C164.566,206.263,164.601,206.263,164.636,206.263z" }),
          React.createElement("path", { fillRule: "evenodd", clipRule: "evenodd", style: { transition: "fill 1s ease", fill: active ? switchColors.secondary : switchColors.primary }, d: "M388.313,210.147c0-6.356,0.034-12.713-0.023-19.069c-0.015-1.61,0.359-2.472,2.19-2.346c2.887,0.198,5.809,0.045,8.671,0.398c4.396,0.542,8.019,4.294,8.144,8.904c0.223,8.142,0.265,16.304-0.074,24.439c-0.248,5.945-4.552,9.662-10.491,9.831c-1.999,0.057-4.003-0.081-6.006-0.09c-1.746-0.008-2.439-0.853-2.428-2.584C388.34,223.136,388.313,216.642,388.313,210.147z M393.418,210.324c-0.037,0-0.075,0-0.114,0c0,4.55-0.038,9.101,0.015,13.65c0.031,2.688,0.926,3.439,3.56,3.239c3.273-0.248,5.493-2.511,5.534-6.04c0.082-7.099,0.054-14.2-0.033-21.299c-0.041-3.268-1.739-5.241-4.87-6.092c-2.68-0.728-4.025,0.161-4.07,2.896C393.364,201.226,393.418,205.775,393.418,210.324z" }),
          React.createElement("path", { fillRule: "evenodd", clipRule: "evenodd", style: { transition: "fill 1s ease", fill: active ? switchColors.secondary : switchColors.primary }, d: "M416.875,210.721c0.068-3.305,1.849-5.306,4.727-5.309c2.765-0.003,4.924,2.404,4.816,5.371c-0.106,2.956-2.355,5.212-5.12,5.138C418.626,215.849,416.813,213.718,416.875,210.721z" }),
          React.createElement("path", { fillRule: "evenodd", clipRule: "evenodd", style: { transition: "fill 1s ease", fill: active ? switchColors.secondary : switchColors.primary }, d: "M440.516,210.627c0,6.281,0.007,12.563-0.004,18.844c-0.004,2.067-0.805,3.038-2.531,3.015c-1.877-0.025-2.365-1.136-2.359-2.876c0.046-12.631,0.019-25.263,0.029-37.895c0.002-2.592,0.525-3.205,2.419-3.148c1.856,0.057,2.479,1.03,2.466,2.803C440.484,197.788,440.515,204.208,440.516,210.627z" }),
          React.createElement("path", { fillRule: "evenodd", clipRule: "evenodd", style: { transition: "fill 1s ease", fill: active ? switchColors.secondary : switchColors.primary }, d: "M449.933,210.636c0.102-3.331,1.886-5.279,4.778-5.22c2.67,0.055,4.829,2.432,4.762,5.243c-0.073,3.021-2.404,5.36-5.242,5.261C451.606,215.829,449.84,213.657,449.933,210.636z" }),
          React.createElement("path", { fillRule: "evenodd", clipRule: "evenodd", style: { transition: "fill 1s ease", fill: active ? switchColors.secondary : switchColors.primary }, d: "M478.079,200.8c0.674-1.566,1.121-2.53,1.506-3.519c0.673-1.73,1.252-3.5,1.981-5.205c0.315-0.737,0.766-1.654,1.407-1.961c1.094-0.523,2.388-0.63,3.598-0.912c0.205,1.142,0.798,2.381,0.537,3.404c-0.606,2.388-1.448,4.756-2.507,6.984c-3.981,8.389-4.352,17.254-3.78,26.282c0.091,1.438,0.031,2.899-0.105,4.335c-0.14,1.473-0.989,2.428-2.542,2.497c-1.514,0.067-2.311-0.903-2.54-2.23c-0.232-1.348-0.394-2.754-0.277-4.108c0.94-10.972-1.116-21.38-5.626-31.375c-0.586-1.298-0.899-2.762-1.093-4.183c-0.233-1.712,0.825-2.592,2.379-1.843c1.164,0.561,2.345,1.55,2.973,2.657c1.078,1.897,1.712,4.043,2.568,6.07C476.918,198.547,477.37,199.361,478.079,200.8z" })
        );
      }
      window.VibesSwitch = VibesSwitch;

      // === HiddenMenuWrapper styles ===
      const hiddenMenuTheme = {
        colors: { menuBg: "var(--vibes-menu-bg)", menuText: "var(--vibes-black)", contentBg: "#1e1e1e", shadow: "rgba(0,0,0,0.3)", gridLineColor: "var(--vibes-menu-grid)" },
        zIndex: { menu: 5, content: 10, toggle: 20 },
        dimensions: { gridSize: "40px", padding: "24px", bottomOffset: "16px" },
        animation: { duration: "0.4s", easing: "ease", blurAmount: "4px" }
      };
      const getWrapperStyle = () => ({ position: "relative", overflow: "hidden" });
      const getMenuStyle = () => ({ position: "fixed", bottom: 0, left: 0, right: 0, zIndex: hiddenMenuTheme.zIndex.menu, color: hiddenMenuTheme.colors.menuText, padding: hiddenMenuTheme.dimensions.padding, boxShadow: "0 -2px 10px " + hiddenMenuTheme.colors.shadow, backgroundColor: hiddenMenuTheme.colors.menuBg, backgroundImage: "linear-gradient(" + hiddenMenuTheme.colors.gridLineColor + " 1px, transparent 1px), linear-gradient(90deg, " + hiddenMenuTheme.colors.gridLineColor + " 1px, transparent 1px)", backgroundSize: hiddenMenuTheme.dimensions.gridSize + " " + hiddenMenuTheme.dimensions.gridSize });
      const getContentWrapperStyle = (menuHeight, menuOpen, isBouncing) => ({ position: "fixed", top: 0, left: 0, right: 0, bottom: 0, zIndex: hiddenMenuTheme.zIndex.content, transition: isBouncing ? "filter 0.3s " + hiddenMenuTheme.animation.easing : "transform " + hiddenMenuTheme.animation.duration + " " + hiddenMenuTheme.animation.easing + ", filter 0.3s " + hiddenMenuTheme.animation.easing, transform: menuOpen ? "translateY(-" + menuHeight + "px)" : "translateY(0)", overflowY: "auto", borderTopColor: hiddenMenuTheme.colors.menuBg, borderTopWidth: "1px", borderTopStyle: "solid", boxShadow: "0 -2px 10px " + hiddenMenuTheme.colors.shadow, backgroundColor: hiddenMenuTheme.colors.contentBg, animation: isBouncing ? "vibes-drop-to-close 0.8s cubic-bezier(0.25,0.46,0.45,0.94)" : undefined, willChange: isBouncing ? "transform" : undefined });
      const getInnerContentWrapperStyle = (menuOpen) => ({ filter: menuOpen ? "blur(" + hiddenMenuTheme.animation.blurAmount + ")" : "none", width: "100%", height: "100%" });
      const getToggleButtonStyle = () => ({ position: "fixed", bottom: hiddenMenuTheme.dimensions.bottomOffset, right: 0, zIndex: hiddenMenuTheme.zIndex.toggle, backgroundColor: "transparent", border: "none", cursor: "pointer" });

      // === HiddenMenuWrapper ===
      function HiddenMenuWrapper({ children, menuContent, showVibesSwitch = true }) {
        const [menuOpen, setMenuOpen] = React.useState(false);
        const [menuHeight, setMenuHeight] = React.useState(0);
        const menuRef = React.useRef(null);
        const buttonRef = React.useRef(null);
        const [isBouncing, setIsBouncing] = React.useState(false);
        const [hasBouncedOnMount, setHasBouncedOnMount] = React.useState(false);

        React.useEffect(() => {
          if (!hasBouncedOnMount && !menuOpen) {
            const prefersReducedMotion = window.matchMedia?.("(prefers-reduced-motion: reduce)")?.matches || false;
            if (!prefersReducedMotion) {
              setIsBouncing(true);
              setTimeout(() => setIsBouncing(false), 800);
            }
            setHasBouncedOnMount(true);
          }
        }, [hasBouncedOnMount, menuOpen]);

        React.useEffect(() => {
          const styleId = "vibes-drop-to-close-keyframes";
          if (!document.getElementById(styleId)) {
            const style = document.createElement("style");
            style.id = styleId;
            style.textContent = "@keyframes vibes-drop-to-close { 0% { transform: translateY(-400px); } 10% { transform: translateY(0); } 25% { transform: translateY(-175px); } 35% { transform: translateY(0); } 48% { transform: translateY(-75px); } 62% { transform: translateY(0); } 72% { transform: translateY(-25px); } 80% { transform: translateY(0); } 82% { transform: translateY(-10px); } 88% { transform: translateY(0); } 91% { transform: translateY(-5px); } 95% { transform: translateY(0); } 100% { transform: translateY(0); } }";
            document.head.appendChild(style);
          }
        }, []);

        React.useEffect(() => {
          if (menuRef.current) setMenuHeight(menuRef.current.offsetHeight);
        }, [menuContent]);

        React.useEffect(() => {
          const handleKeyDown = (e) => {
            if (e.key === "Escape" && menuOpen) {
              setMenuOpen(false);
              buttonRef.current?.focus();
            }
          };
          document.addEventListener("keydown", handleKeyDown);
          return () => document.removeEventListener("keydown", handleKeyDown);
        }, [menuOpen]);

        return React.createElement("div", { style: getWrapperStyle() },
          React.createElement("div", { ref: menuRef, style: getMenuStyle() }, menuContent),
          React.createElement("div", { style: getContentWrapperStyle(menuHeight, menuOpen, isBouncing) },
            React.createElement("div", { style: getInnerContentWrapperStyle(menuOpen) },
              React.createElement("div", { style: { width: "100%", height: "100%" } }, children)
            )
          ),
          showVibesSwitch && React.createElement("button", { ref: buttonRef, onClick: () => setMenuOpen(!menuOpen), style: getToggleButtonStyle() },
            React.createElement(VibesSwitch, { size: 80 })
          )
        );
      }
      window.HiddenMenuWrapper = HiddenMenuWrapper;

      // === VibesButton ===
      const variantColors = { blue: "var(--vibes-variant-blue)", red: "var(--vibes-variant-red)", yellow: "var(--vibes-variant-yellow)", gray: "var(--vibes-variant-gray)" };
      function VibesButton({ variant = "blue", children, onClick, href, style: customStyle }) {
        const [isHovered, setHovered] = React.useState(false);
        const [isActive, setActive] = React.useState(false);
        const cssColor = variantColors[variant] || variant;
        let transform = "translate(0px, 0px)";
        let boxShadow = "8px 10px 0px 0px " + cssColor + ", 8px 10px 0px 2px var(--vibes-button-border)";
        if (isHovered && !isActive) { transform = "translate(2px, 2px)"; boxShadow = "2px 3px 0px 0px " + cssColor + ", 2px 3px 0px 2px var(--vibes-button-border)"; }
        if (isActive) { transform = "translate(4px, 5px)"; boxShadow = "none"; }
        const baseStyle = { width: "100%", minHeight: "60px", padding: "0.75rem 1.5rem", borderRadius: "12px", fontSize: "1rem", fontWeight: 700, textTransform: "uppercase", letterSpacing: "0.05em", cursor: "pointer", transition: "all 0.15s ease", transform, boxShadow, background: "var(--vibes-button-bg)", color: "var(--vibes-button-text)", border: "2px solid var(--vibes-button-border)", textDecoration: "none", display: "flex", alignItems: "center", justifyContent: "center", ...customStyle };
        const props = { style: baseStyle, onMouseEnter: () => setHovered(true), onMouseLeave: () => { setHovered(false); setActive(false); }, onMouseDown: () => setActive(true), onMouseUp: () => setActive(false) };
        if (href) return React.createElement("a", { ...props, href, target: "_blank", rel: "noopener noreferrer" }, children);
        return React.createElement("button", { ...props, onClick }, children);
      }
      window.VibesButton = VibesButton;

      // === VibesPanel ===
      function VibesPanel() {
        return React.createElement("div", { style: { display: "flex", flexDirection: "column", gap: "12px", alignItems: "center", maxWidth: "400px", margin: "0 auto" } },
          React.createElement(VibesButton, { variant: "blue", href: "https://vibes.diy" }, "VISIT VIBES.DIY"),
          React.createElement(VibesButton, { variant: "yellow", href: "https://vibes.diy" }, "CREATE YOUR OWN")
        );
      }
      window.VibesPanel = VibesPanel;
    </script>
    <script type="text/babel" data-type="module">
      import React, { createContext, useContext, useState, useEffect, useRef, useCallback, useMemo, useReducer } from "react";
      import ReactDOMClient from "react-dom/client";
      import { createPortal } from "react-dom";
      import { useFireproof } from "use-fireproof";
      import {
        ClerkProvider,
        SignedIn,
        SignedOut,
        SignInButton,
        SignUpButton,
        UserButton,
        useUser,
        useAuth
      } from "@clerk/clerk-react";

      // === Menu Components from window (defined in module script above) ===
      const HiddenMenuWrapper = window.HiddenMenuWrapper;
      const VibesPanel = window.VibesPanel;
      const VibesSwitch = window.VibesSwitch;
      const VibesButton = window.VibesButton;

      // === Configuration ===
      const CLERK_PUBLISHABLE_KEY = "pk_test_Zml0LWFudGVhdGVyLTY1LmNsZXJrLmFjY291bnRzLmRldiQ";
      const APP_NAME = "knitting";
      const APP_DOMAIN = "knitting.computer";
      const MONTHLY_PRICE = "5";
      const YEARLY_PRICE = "50";
      const FEATURES = ["AI pattern generation","Visual previews","Pattern library"];
      const APP_TAGLINE = "AI-powered knitting pattern designer";
      const ADMIN_USER_IDS = ["user_37Rr9dmWe8mvDiABbtmfarVj6A2"];

      // === Route Detection ===
      function getRouteInfo() {
        const hostname = window.location.hostname;
        const parts = hostname.split('.');
        const params = new URLSearchParams(window.location.search);
        const testSubdomain = params.get('subdomain');

        // Handle localhost for testing
        if (hostname === 'localhost' || hostname === '127.0.0.1') {
          if (testSubdomain === 'admin') return { route: 'admin', subdomain: null };
          if (testSubdomain) return { route: 'tenant', subdomain: testSubdomain };
          return { route: 'landing', subdomain: null };
        }

        // Handle pages.dev for testing (before custom domain is set up)
        if (hostname.endsWith('.pages.dev')) {
          if (testSubdomain === 'admin') return { route: 'admin', subdomain: null };
          if (testSubdomain) return { route: 'tenant', subdomain: testSubdomain };
          return { route: 'landing', subdomain: null };
        }

        // Production: detect subdomain from hostname
        if (parts.length <= 2 || parts[0] === 'www') {
          return { route: 'landing', subdomain: null };
        }
        if (parts[0] === 'admin') {
          return { route: 'admin', subdomain: null };
        }
        return { route: 'tenant', subdomain: parts[0] };
      }

      const routeInfo = getRouteInfo();

      // === Tenant Context ===
      const TenantContext = createContext(null);

      function useTenant() {
        const context = useContext(TenantContext);
        if (!context) throw new Error("useTenant must be used within TenantProvider");
        return context;
      }

      // Make useTenant available globally for the embedded App
      window.useTenant = useTenant;

      function TenantProvider({ children, subdomain }) {
        const dbName = `${APP_NAME}-${subdomain}`;
        return (
          <TenantContext.Provider value={{ subdomain, dbName, appName: APP_NAME, domain: APP_DOMAIN }}>
            {children}
          </TenantContext.Provider>
        );
      }

      // === Subscription Gate ===
      function SubscriptionRequired() {
        return (
          <div className="min-h-screen flex items-center justify-center bg-[oklch(0.95_0.02_250)] p-4">
            <div className="max-w-md text-center p-8 bg-white border-4 border-[#0f172a] shadow-[8px_8px_0px_#0f172a]">
              <h2 className="text-2xl font-bold mb-4">Subscription Required</h2>
              <p className="mb-6">Please subscribe to access this app.</p>
              <a
                href={`https://${APP_DOMAIN}`}
                className="inline-block px-6 py-3 bg-[oklch(0.6_0.2_145)] text-white font-bold border-4 border-[#0f172a] shadow-[4px_4px_0px_#0f172a] hover:shadow-[2px_2px_0px_#0f172a] transition-all"
              >
                View Plans
              </a>
            </div>
          </div>
        );
      }

      function SubscriptionGate({ children }) {
        const { has, isLoaded, userId } = useAuth();
        const { user } = useUser();

        if (!isLoaded) {
          return (
            <div className="min-h-screen flex items-center justify-center bg-[oklch(0.95_0.02_250)]">
              <div className="animate-pulse text-lg font-bold">Loading...</div>
            </div>
          );
        }

        // Allow admin users to bypass subscription check
        const isAdmin = ADMIN_USER_IDS.includes(userId);

        // Check Clerk Billing subscriptions
        const hasClerkSubscription = has({ plan: 'free' }) || has({ plan: 'pro' }) || has({ plan: 'basic' }) || has({ plan: 'monthly' }) || has({ plan: 'yearly' }) || has({ plan: 'starter' });

        // Check user metadata for plan (set during checkout flow or tenant registration)
        const metadataPlan = user?.unsafeMetadata?.plan;
        const hasMetadataPlan = ['free', 'pro', 'basic', 'monthly', 'yearly', 'starter'].includes(metadataPlan);

        const hasSubscription = isAdmin || hasClerkSubscription || hasMetadataPlan;

        if (!hasSubscription) {
          return <SubscriptionRequired />;
        }

        return children;
      }

      // === Original App Code (embedded during assembly) ===
      // 


const SIZES = ["XS", "S", "M", "L", "XL", "XXL"];
const GENDERS = ["Women", "Men", "Unisex"];
const STYLES = ["Minimalist", "Chunky", "Vintage", "Nordic", "Experimental", "Classic", "Bohemian", "Athleisure"];

const SYSTEM_PROMPT = `You are a professional sweater pattern designer creating production-ready patterns. Generate 1 complete sweater pattern based on the user's specifications.

Each pattern MUST include ALL of these sections with full technical detail:

1. PATTERN OVERVIEW
- Name, style keywords, difficulty (beginner/intermediate/advanced), construction type (top-down raglan, bottom-up seamed, circular yoke, drop shoulder, set-in sleeve, etc.)

2. SIZES
- Sizes offered (XS, S, M, L, XL, XXL with corresponding bust/chest measurements)
- Finished measurements for the requested size: chest circumference, body length, sleeve length, upper arm circumference
- Ease recommendation (e.g., "2-4 inches positive ease recommended")

3. GAUGE
- Stitches per 4 inches/10cm AND rows per 4 inches/10cm
- Specify the stitch pattern used for gauge (stockinette, pattern stitch, etc.)
- Flat or in-the-round
- Blocked or unblocked

4. YARN
- Weight category (Lace/Fingering/Sport/DK/Worsted/Aran/Bulky/Super Bulky)
- Fiber suggestion with reasoning
- Specific yardage needed for the requested size (in yards AND meters)

5. NEEDLES & NOTIONS
- Main needle size (US and metric) for body
- Ribbing needle size (typically 1-2 sizes smaller)
- Circular needle lengths needed, and/or DPNs
- Number of stitch markers needed
- Other notions: tapestry needle, waste yarn, cable needle if needed, etc.

6. ABBREVIATIONS
- List all abbreviations used in the pattern using CYC-standard format
- Include a mini key for any nonstandard abbreviations

7. INSTRUCTIONS
- Step-by-step sections with round/row numbering
- Include stitch counts at key points (after increases, at armhole division, etc.)
- Clear repeat logic using standard notation like [k2, p2] x 10
- Specific measurements for "work even until piece measures X inches/cm"
- Sections: Cast On & Ribbing, Body/Yoke, Armhole Shaping (if applicable), Sleeves, Neckline, Finishing

8. FINISHING & BLOCKING
- Seaming instructions if any pieces are worked flat
- Weave-in guidance
- Blocking instructions matched to the fiber suggestion (wet block, steam, etc.)
- Final measurements to block to

9. CUSTOMIZATION NOTES
- 2-3 specific modifications the knitter can make:
  - Body length adjustment
  - Waist shaping option (if not included)
  - Neckline variant (crew vs V vs boat)
  - Sleeve length/taper options

Be extremely specific and technical. Every instruction should be actionable. Use standard knitting abbreviations. This pattern should be complete enough that an experienced knitter could make the sweater without additional resources.

Respond with valid JSON array of patterns:
[{
  "name": "Pattern Name",
  "overview": {
    "style": "style keywords",
    "difficulty": "beginner/intermediate/advanced",
    "construction": "construction method description"
  },
  "sizes": {
    "available": "XS (30\\"), S (34\\"), M (38\\"), L (42\\"), XL (46\\"), XXL (50\\")",
    "finishedMeasurements": {
      "chest": "X inches",
      "bodyLength": "X inches",
      "sleeveLength": "X inches",
      "upperArm": "X inches"
    },
    "ease": "ease recommendation"
  },
  "gauge": {
    "stitches": "X sts per 4 inches",
    "rows": "X rows per 4 inches",
    "pattern": "stockinette/pattern stitch",
    "method": "in the round, blocked"
  },
  "yarn": {
    "weight": "DK/Worsted/etc",
    "fiber": "fiber recommendation and why",
    "yardage": "X yards (X meters)"
  },
  "needles": {
    "main": "US X (X mm)",
    "ribbing": "US X (X mm)",
    "type": "32\\" circular for body, 16\\" circular or DPNs for sleeves",
    "notions": "X stitch markers, tapestry needle, waste yarn"
  },
  "abbreviations": "k=knit, p=purl, k2tog=knit 2 together, ssk=slip slip knit, pm=place marker, sm=slip marker, etc.",
  "instructions": {
    "castOn": "Detailed cast on and ribbing instructions with stitch counts",
    "body": "Body instructions with row/round numbers and stitch counts",
    "sleeves": "Sleeve instructions",
    "neckline": "Neckline shaping",
    "finishing": "Final assembly steps"
  },
  "blocking": "Complete blocking and finishing instructions",
  "customization": ["Modification 1", "Modification 2", "Modification 3"]
}]`;

function ImageThumbnail({ src, alt, onExpand }) {
  return (
    <button
      type="button"
      className="relative cursor-pointer group w-full h-full min-h-[160px]"
      onClick={() => onExpand(src, alt)}
    >
      <img
        src={src}
        alt={alt}
        className="w-full h-full object-contain p-2"
      />
      <div className="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors flex items-end justify-center pb-2">
        <span className="opacity-0 group-hover:opacity-100 transition-opacity text-white bg-black/60 px-2 py-0.5 rounded text-xs">
          View larger
        </span>
      </div>
    </button>
  );
}

function Lightbox({ src, alt, onClose }) {
  if (!src) return null;

  // Use portal to render directly into document.body, bypassing any container transforms
  return createPortal(
    <div
      onClick={onClose}
      style={{
        position: 'fixed',
        top: 0,
        left: 0,
        right: 0,
        bottom: 0,
        zIndex: 99999,
        backgroundColor: 'rgba(0,0,0,0.92)',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        padding: '1rem'
      }}
    >
      <div
        style={{ position: 'relative' }}
        onClick={(e) => e.stopPropagation()}
      >
        <img
          src={src}
          alt={alt}
          style={{
            maxWidth: '90vw',
            maxHeight: '90vh',
            objectFit: 'contain',
            borderRadius: '0.5rem',
            boxShadow: '0 25px 50px -12px rgba(0,0,0,0.5)'
          }}
        />
        <button
          type="button"
          onClick={onClose}
          style={{
            position: 'absolute',
            top: '-12px',
            right: '-12px',
            width: '40px',
            height: '40px',
            backgroundColor: 'white',
            borderRadius: '50%',
            border: 'none',
            boxShadow: '0 4px 12px rgba(0,0,0,0.3)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            fontSize: '20px',
            fontWeight: 'bold',
            color: '#666',
            cursor: 'pointer'
          }}
        >
          âœ•
        </button>
      </div>
    </div>,
    document.body
  );
}

function YarnSpinner() {
  return (
    <div className="flex flex-col items-center gap-3">
      <div className="relative w-16 h-16">
        <div className="absolute inset-0 rounded-full border-4 border-[oklch(0.65_0.12_290)] border-t-transparent animate-spin" />
        <div className="absolute inset-2 rounded-full bg-[oklch(0.92_0.04_50)]" />
        <div className="absolute inset-4 rounded-full bg-[oklch(0.65_0.12_290)]" />
      </div>
      <p className="text-[oklch(0.55_0.08_350)] text-sm animate-pulse">Winding up your patterns...</p>
    </div>
  );
}

function PatternCard({ pattern, index, onImageExpand }) {
  const [expandedSections, setExpandedSections] = useState({
    overview: true,
    sizes: false,
    gauge: false,
    yarn: false,
    needles: false,
    abbreviations: false,
    instructions: false,
    blocking: false,
    customization: false
  });

  const colors = [
    "oklch(0.60_0.12_350)", // dusty rose
    "oklch(0.60_0.12_290)", // lavender
    "oklch(0.55_0.08_30)", // warm mauve
  ];
  const accentColor = colors[index % colors.length];

  const toggleSection = (section) => {
    setExpandedSections(prev => ({ ...prev, [section]: !prev[section] }));
  };

  const expandAll = () => {
    const allExpanded = {};
    Object.keys(expandedSections).forEach(k => allExpanded[k] = true);
    setExpandedSections(allExpanded);
  };

  const collapseAll = () => {
    const allCollapsed = {};
    Object.keys(expandedSections).forEach(k => allCollapsed[k] = false);
    setExpandedSections(allCollapsed);
  };

  return (
    <div className="bg-[oklch(0.99_0.02_50)] rounded-2xl shadow-lg overflow-hidden border border-[oklch(0.92_0.04_350)]">
      <div className="h-2" style={{ backgroundColor: accentColor }} />

      {/* Header with Image and Title side by side */}
      <div className="flex">
        {/* Image on left */}
        {pattern.imageUrl && (
          <div className="flex-shrink-0 w-48">
            <ImageThumbnail src={pattern.imageUrl} alt={pattern.name} onExpand={onImageExpand} />
          </div>
        )}

        {/* Title and info on right */}
        <div className="flex-1 p-5 flex flex-col justify-center">
          <h3 className="text-2xl font-bold mb-2" style={{ color: accentColor }}>
            {pattern.name}
          </h3>
          {pattern.overview && (
            <div className="flex flex-wrap gap-2 text-xs mb-3">
              <span className="px-2 py-1 rounded-full bg-[oklch(0.94_0.04_350)] text-[oklch(0.45_0.08_350)]">
                {pattern.overview.difficulty}
              </span>
              <span className="px-2 py-1 rounded-full bg-[oklch(0.94_0.04_350)] text-[oklch(0.45_0.08_350)]">
                {pattern.overview.construction}
              </span>
              {pattern.overview.style && (
                <span className="px-2 py-1 rounded-full bg-[oklch(0.94_0.04_350)] text-[oklch(0.45_0.08_350)]">
                  {pattern.overview.style}
                </span>
              )}
            </div>
          )}
          {pattern.yarn && (
            <p className="text-sm text-[oklch(0.45_0.04_350)] mb-3">
              <span className="font-medium">{pattern.yarn.weight}</span> Â· {pattern.yarn.fiber}
            </p>
          )}
          <div className="flex gap-2">
            <button onClick={expandAll} className="text-xs text-[oklch(0.55_0.12_290)] hover:underline">
              Expand all
            </button>
            <span className="text-[oklch(0.80_0.03_350)]">|</span>
            <button onClick={collapseAll} className="text-xs text-[oklch(0.55_0.12_290)] hover:underline">
              Collapse all
            </button>
          </div>
        </div>
      </div>

      <div className="divide-y divide-[oklch(0.94_0.03_350)]">
        {/* Sizes */}
        <CollapsibleSection
          title="Sizes & Measurements"
          icon="ðŸ“"
          isOpen={expandedSections.sizes}
          onToggle={() => toggleSection('sizes')}
          accentColor={accentColor}
        >
          {pattern.sizes && (
            <div className="space-y-3 text-sm">
              <p><strong>Available:</strong> {pattern.sizes.available}</p>
              <p><strong>Ease:</strong> {pattern.sizes.ease}</p>
              {pattern.sizes.finishedMeasurements && (
                <div className="grid grid-cols-2 gap-2 p-3 bg-[oklch(0.96_0.03_50)] rounded-lg">
                  <div><strong>Chest:</strong> {pattern.sizes.finishedMeasurements.chest}</div>
                  <div><strong>Body Length:</strong> {pattern.sizes.finishedMeasurements.bodyLength}</div>
                  <div><strong>Sleeve Length:</strong> {pattern.sizes.finishedMeasurements.sleeveLength}</div>
                  <div><strong>Upper Arm:</strong> {pattern.sizes.finishedMeasurements.upperArm}</div>
                </div>
              )}
            </div>
          )}
        </CollapsibleSection>

        {/* Gauge */}
        <CollapsibleSection
          title="Gauge"
          icon="ðŸ“"
          isOpen={expandedSections.gauge}
          onToggle={() => toggleSection('gauge')}
          accentColor={accentColor}
        >
          {pattern.gauge && (
            <div className="space-y-2 text-sm">
              <p><strong>Stitches:</strong> {pattern.gauge.stitches}</p>
              <p><strong>Rows:</strong> {pattern.gauge.rows}</p>
              <p><strong>Pattern:</strong> {pattern.gauge.pattern}</p>
              <p><strong>Method:</strong> {pattern.gauge.method}</p>
            </div>
          )}
        </CollapsibleSection>

        {/* Yarn */}
        <CollapsibleSection
          title="Yarn"
          icon="ðŸ§¶"
          isOpen={expandedSections.yarn}
          onToggle={() => toggleSection('yarn')}
          accentColor={accentColor}
        >
          {pattern.yarn && (
            <div className="space-y-2 text-sm">
              <p><strong>Weight:</strong> {pattern.yarn.weight}</p>
              <p><strong>Fiber:</strong> {pattern.yarn.fiber}</p>
              <p><strong>Yardage:</strong> {pattern.yarn.yardage}</p>
            </div>
          )}
        </CollapsibleSection>

        {/* Needles & Notions */}
        <CollapsibleSection
          title="Needles & Notions"
          icon="ðŸª¡"
          isOpen={expandedSections.needles}
          onToggle={() => toggleSection('needles')}
          accentColor={accentColor}
        >
          {pattern.needles && (
            <div className="space-y-2 text-sm">
              <p><strong>Main:</strong> {pattern.needles.main}</p>
              <p><strong>Ribbing:</strong> {pattern.needles.ribbing}</p>
              <p><strong>Type:</strong> {pattern.needles.type}</p>
              <p><strong>Notions:</strong> {pattern.needles.notions}</p>
            </div>
          )}
        </CollapsibleSection>

        {/* Abbreviations */}
        <CollapsibleSection
          title="Abbreviations"
          icon="ðŸ“"
          isOpen={expandedSections.abbreviations}
          onToggle={() => toggleSection('abbreviations')}
          accentColor={accentColor}
        >
          <p className="text-sm text-[oklch(0.40_0.02_30)] whitespace-pre-wrap">
            {pattern.abbreviations}
          </p>
        </CollapsibleSection>

        {/* Instructions */}
        <CollapsibleSection
          title="Instructions"
          icon="ðŸ“‹"
          isOpen={expandedSections.instructions}
          onToggle={() => toggleSection('instructions')}
          accentColor={accentColor}
        >
          {pattern.instructions && (
            <div className="space-y-4 text-sm">
              {pattern.instructions.castOn && (
                <div>
                  <h5 className="font-semibold text-[oklch(0.35_0.05_30)] mb-1">Cast On & Ribbing</h5>
                  <p className="text-[oklch(0.40_0.02_30)] whitespace-pre-wrap">{pattern.instructions.castOn}</p>
                </div>
              )}
              {pattern.instructions.body && (
                <div>
                  <h5 className="font-semibold text-[oklch(0.35_0.05_30)] mb-1">Body</h5>
                  <p className="text-[oklch(0.40_0.02_30)] whitespace-pre-wrap">{pattern.instructions.body}</p>
                </div>
              )}
              {pattern.instructions.sleeves && (
                <div>
                  <h5 className="font-semibold text-[oklch(0.35_0.05_30)] mb-1">Sleeves</h5>
                  <p className="text-[oklch(0.40_0.02_30)] whitespace-pre-wrap">{pattern.instructions.sleeves}</p>
                </div>
              )}
              {pattern.instructions.neckline && (
                <div>
                  <h5 className="font-semibold text-[oklch(0.35_0.05_30)] mb-1">Neckline</h5>
                  <p className="text-[oklch(0.40_0.02_30)] whitespace-pre-wrap">{pattern.instructions.neckline}</p>
                </div>
              )}
              {pattern.instructions.finishing && (
                <div>
                  <h5 className="font-semibold text-[oklch(0.35_0.05_30)] mb-1">Finishing</h5>
                  <p className="text-[oklch(0.40_0.02_30)] whitespace-pre-wrap">{pattern.instructions.finishing}</p>
                </div>
              )}
            </div>
          )}
        </CollapsibleSection>

        {/* Blocking */}
        <CollapsibleSection
          title="Finishing & Blocking"
          icon="âœ¨"
          isOpen={expandedSections.blocking}
          onToggle={() => toggleSection('blocking')}
          accentColor={accentColor}
        >
          <p className="text-sm text-[oklch(0.40_0.02_30)] whitespace-pre-wrap">
            {pattern.blocking}
          </p>
        </CollapsibleSection>

        {/* Customization */}
        <CollapsibleSection
          title="Customization Notes"
          icon="ðŸ’¡"
          isOpen={expandedSections.customization}
          onToggle={() => toggleSection('customization')}
          accentColor={accentColor}
        >
          {pattern.customization && Array.isArray(pattern.customization) && (
            <ul className="list-disc list-inside space-y-1 text-sm text-[oklch(0.40_0.02_30)]">
              {pattern.customization.map((mod, i) => (
                <li key={i}>{mod}</li>
              ))}
            </ul>
          )}
        </CollapsibleSection>
      </div>
    </div>
  );
}

function CollapsibleSection({ title, icon, isOpen, onToggle, children, accentColor }) {
  return (
    <div>
      <button
        onClick={onToggle}
        className="w-full px-6 py-4 flex items-center justify-between hover:bg-[oklch(0.97_0.03_350)] transition-colors"
      >
        <span className="flex items-center gap-2 font-medium text-[oklch(0.40_0.06_350)]">
          <span>{icon}</span>
          {title}
        </span>
        <span className="text-[oklch(0.60_0.10_290)] text-lg">
          {isOpen ? 'âˆ’' : '+'}
        </span>
      </button>
      {isOpen && (
        <div className="px-6 pb-4 text-[oklch(0.40_0.03_350)]">
          {children}
        </div>
      )}
    </div>
  );
}

// API endpoint - uses Cloudflare Worker proxy in production
const API_BASE = window.location.hostname === 'localhost'
  ? 'http://localhost:8787'  // Local wrangler dev
  : 'https://knitting-api.marcus-e.workers.dev';  // TODO: change to api.knitting.computer after DNS setup

// Get tenant subdomain for database isolation
function getSubdomain() {
  const hostname = window.location.hostname;
  if (hostname === 'localhost' || hostname === '127.0.0.1') {
    const params = new URLSearchParams(window.location.search);
    return params.get('subdomain') || 'local';
  }
  const parts = hostname.split('.');
  if (parts.length >= 2) {
    return parts[0];
  }
  return 'default';
}

function App() {
  const subdomain = getSubdomain();
  const { useLiveQuery, useDocument, database } = useFireproof(`knitting-${subdomain}`);

  const [gender, setGender] = useState("Women");
  const [size, setSize] = useState("M");
  const [customSize, setCustomSize] = useState("");
  const [selectedStyles, setSelectedStyles] = useState([]);
  const [customRequest, setCustomRequest] = useState("");
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");
  const [patterns, setPatterns] = useState([]);
  const [lightboxImage, setLightboxImage] = useState(null);

  const openLightbox = (src, alt) => setLightboxImage({ src, alt });
  const closeLightbox = () => setLightboxImage(null);

  const toggleStyle = (style) => {
    setSelectedStyles(prev =>
      prev.includes(style)
        ? prev.filter(s => s !== style)
        : [...prev, style]
    );
  };

  const generatePatterns = async () => {
    setLoading(true);
    setError("");
    setPatterns([]);

    const sizeSpec = customSize || size;
    const styleSpec = selectedStyles.length > 0 ? selectedStyles.join(", ") : "any style";

    const customNote = customRequest.trim() ? `\n- Special requests: ${customRequest.trim()}` : "";

    const userPrompt = `Generate sweater patterns for:
- Target: ${gender}
- Size: ${sizeSpec}
- Style preferences: ${styleSpec}${customNote}

Create 1 fully specified pattern that an experienced knitter could start immediately.`;

    try {
      const response = await fetch(`${API_BASE}/api/generate-pattern`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          model: "anthropic/claude-sonnet-4",
          messages: [
            { role: "system", content: SYSTEM_PROMPT },
            { role: "user", content: userPrompt }
          ],
          temperature: 0.8,
        }),
      });

      if (!response.ok) {
        throw new Error(`API error: ${response.status}`);
      }

      const data = await response.json();
      const content = data.choices[0]?.message?.content;

      // Parse the JSON from the response
      const jsonMatch = content.match(/\[[\s\S]*\]/);
      if (jsonMatch) {
        const parsedPatterns = JSON.parse(jsonMatch[0]);

        // Generate images for each pattern
        const patternsWithImages = await Promise.all(
          parsedPatterns.map(async (pattern) => {
            try {
              const imagePrompt = `A beautiful hand-knitted sweater: ${pattern.name}. ${pattern.overview?.construction || ''}. Made with ${pattern.yarn?.fiber || 'wool'}. ${pattern.overview?.style || ''} style. Professional product photography on clean background, soft lighting, high quality knitwear.`;

              const imageResponse = await fetch(`${API_BASE}/api/generate-image`, {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  model: "google/gemini-2.5-flash-image",
                  messages: [
                    {
                      role: "user",
                      content: `Generate an image of: ${imagePrompt}`
                    }
                  ],
                }),
              });

              if (imageResponse.ok) {
                const imageData = await imageResponse.json();
                const message = imageData.choices?.[0]?.message;

                // Check for images array (Gemini format)
                if (message?.images?.[0]?.image_url?.url) {
                  return { ...pattern, imageUrl: message.images[0].image_url.url };
                }
              } else {
                console.error("Image API error:", imageResponse.status, await imageResponse.text());
              }
            } catch (imgErr) {
              console.error("Image generation failed:", imgErr);
            }
            return pattern;
          })
        );

        setPatterns(patternsWithImages);

        // Save to Fireproof with images as file attachments
        const _files = {};
        const patternsForStorage = patternsWithImages.map((p, idx) => {
          const { imageUrl, ...rest } = p;
          if (imageUrl && imageUrl.startsWith('data:')) {
            // Convert base64 to Blob/File for Fireproof storage
            const [header, base64] = imageUrl.split(',');
            const mimeMatch = header.match(/data:([^;]+)/);
            const mimeType = mimeMatch ? mimeMatch[1] : 'image/png';
            const binary = atob(base64);
            const bytes = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) {
              bytes[i] = binary.charCodeAt(i);
            }
            const blob = new Blob([bytes], { type: mimeType });
            const fileName = `pattern-${idx}.png`;
            _files[fileName] = new File([blob], fileName, { type: mimeType });
            return { ...rest, imageFileName: fileName };
          }
          return rest;
        });

        await database.put({
          type: "generation",
          gender,
          size: sizeSpec,
          styles: selectedStyles,
          patterns: patternsForStorage,
          _files,
          createdAt: new Date().toISOString(),
        });
      } else {
        throw new Error("Could not parse patterns from response");
      }
    } catch (err) {
      setError(err.message || "Failed to generate patterns");
    } finally {
      setLoading(false);
    }
  };

  const { docs: history } = useLiveQuery("type", { key: "generation", descending: true, limit: 5 });

  // Load patterns from history with their file attachments
  const loadFromHistory = async (gen) => {
    try {
      // Get the full document with file attachments
      const doc = await database.get(gen._id);

      // Load images from _files attachments
      const patternsWithImages = await Promise.all(
        (doc.patterns || []).map(async (pattern) => {
          if (pattern.imageFileName && doc._files?.[pattern.imageFileName]?.file) {
            try {
              const fileObj = await doc._files[pattern.imageFileName].file();
              const imageUrl = URL.createObjectURL(fileObj);
              return { ...pattern, imageUrl };
            } catch (e) {
              console.error("Failed to load image file:", e);
            }
          }
          return pattern;
        })
      );

      setPatterns(patternsWithImages);
    } catch (e) {
      console.error("Failed to load from history:", e);
      // Fallback to patterns without images
      setPatterns(gen.patterns || []);
    }
  };

  return (
    <>
    <div className="min-h-screen bg-[oklch(0.97_0.02_350)]">
      {/* Header */}
      <header className="bg-[linear-gradient(180deg_in_oklch,oklch(0.82_0.12_330),oklch(0.88_0.10_10))] pt-8 pb-16 px-4 relative overflow-hidden">
        <div className="absolute inset-0 opacity-20">
          <div className="absolute top-4 left-[10%] text-6xl">ðŸ§¶</div>
          <div className="absolute top-12 right-[15%] text-4xl">ðŸª¡</div>
          <div className="absolute bottom-8 left-[20%] text-5xl">ðŸ§µ</div>
          <div className="absolute bottom-4 right-[10%] text-6xl">ðŸ§¶</div>
        </div>
        <div className="max-w-4xl mx-auto text-center relative">
          <img
            src="logo.png"
            alt="The Knitting Computer"
            className="w-44 h-44 object-contain mx-auto mb-3 drop-shadow-lg"
          />
          <h1 className="text-3xl font-bold tracking-tight text-[oklch(0.35_0.12_350)]">The Knitting Computer</h1>
          <p className="text-[oklch(0.45_0.10_350)] text-sm mt-1 font-medium">
            AI-Powered Knitting Pattern Designer
          </p>
        </div>
      </header>

      <main className="max-w-4xl mx-auto px-4 -mt-8 relative z-10">
        {/* Input Form */}
        <div className="bg-[oklch(0.99_0.02_50)] rounded-2xl shadow-xl p-6 mb-8 border border-[oklch(0.92_0.04_350)]">
          <h2 className="text-xl font-bold text-[oklch(0.40_0.10_350)] mb-6">
            Design Your Sweater
          </h2>

          {/* Gender & Size Row */}
          <div className="grid md:grid-cols-2 gap-6 mb-6">
            <div>
              <label className="block text-sm font-medium text-[oklch(0.45_0.06_350)] mb-2">
                Target Gender
              </label>
              <div className="flex flex-wrap gap-2">
                {GENDERS.map(g => (
                  <button
                    key={g}
                    onClick={() => setGender(g)}
                    className={`px-4 py-2 rounded-full text-sm font-medium transition-all ${
                      gender === g
                        ? "bg-[oklch(0.60_0.12_350)] text-white"
                        : "bg-[oklch(0.94_0.03_350)] text-[oklch(0.45_0.06_350)] hover:bg-[oklch(0.90_0.05_350)]"
                    }`}
                  >
                    {g}
                  </button>
                ))}
              </div>
            </div>

            <div>
              <label className="block text-sm font-medium text-[oklch(0.45_0.06_350)] mb-2">
                Size
              </label>
              <div className="flex flex-wrap gap-2 mb-2">
                {SIZES.map(s => (
                  <button
                    key={s}
                    onClick={() => { setSize(s); setCustomSize(""); }}
                    className={`w-12 h-10 rounded-lg text-sm font-medium transition-all ${
                      size === s && !customSize
                        ? "bg-[oklch(0.60_0.12_290)] text-white"
                        : "bg-[oklch(0.94_0.03_350)] text-[oklch(0.45_0.06_350)] hover:bg-[oklch(0.90_0.05_350)]"
                    }`}
                  >
                    {s}
                  </button>
                ))}
              </div>
              <input
                type="text"
                value={customSize}
                onChange={(e) => setCustomSize(e.target.value)}
                placeholder="Or enter chest measurement (e.g., 38 inches)"
                className="w-full px-3 py-2 text-sm rounded-lg border border-[oklch(0.88_0.04_350)] focus:border-[oklch(0.60_0.12_290)] focus:outline-none"
              />
            </div>
          </div>

          {/* Style Preferences */}
          <div className="mb-6">
            <label className="block text-sm font-medium text-[oklch(0.45_0.06_350)] mb-2">
              Style Preferences (optional, select any that appeal)
            </label>
            <div className="flex flex-wrap gap-2">
              {STYLES.map(style => (
                <button
                  key={style}
                  onClick={() => toggleStyle(style)}
                  className={`px-4 py-2 rounded-full text-sm font-medium transition-all ${
                    selectedStyles.includes(style)
                      ? "bg-[oklch(0.60_0.12_290)] text-white"
                      : "bg-[oklch(0.94_0.03_350)] text-[oklch(0.45_0.06_350)] hover:bg-[oklch(0.90_0.05_350)]"
                  }`}
                >
                  {style}
                </button>
              ))}
            </div>
          </div>

          {/* Custom Request */}
          <div className="mb-6">
            <label className="block text-sm font-medium text-[oklch(0.45_0.06_350)] mb-2">
              Special Requests (optional)
            </label>
            <textarea
              value={customRequest}
              onChange={(e) => setCustomRequest(e.target.value)}
              placeholder="E.g., cropped length, include a hood, colorwork yoke, oversized fit, pockets, split hem, etc."
              rows={3}
              className="w-full px-4 py-3 rounded-xl border-2 border-[oklch(0.90_0.04_350)] focus:border-[oklch(0.60_0.12_350)] focus:outline-none transition-colors bg-[oklch(0.98_0.02_50)] resize-none text-sm"
            />
          </div>

          {/* Generate Button */}
          <button
            onClick={generatePatterns}
            disabled={loading}
            className="w-full py-4 rounded-xl bg-[linear-gradient(135deg_in_oklch,oklch(0.60_0.12_350),oklch(0.55_0.12_290))] text-white font-bold text-lg hover:opacity-90 transition-all disabled:opacity-50 disabled:cursor-not-allowed shadow-lg"
          >
            {loading ? "Designing..." : "ðŸ± Generate Pattern Ideas"}
          </button>

          {error && (
            <p className="mt-4 text-center text-[oklch(0.55_0.15_25)]">{error}</p>
          )}
        </div>

        {/* Loading State */}
        {loading && (
          <div className="flex justify-center py-12">
            <YarnSpinner />
          </div>
        )}

        {/* Generated Patterns */}
        {patterns.length > 0 && (
          <div>
            <h2 className="text-2xl font-bold text-[oklch(0.45_0.10_350)] mb-6 text-center">
              Your Pattern Concepts
            </h2>
            <div className="space-y-6">
              {patterns.map((pattern, idx) => (
                <PatternCard key={idx} pattern={pattern} index={idx} onImageExpand={openLightbox} />
              ))}
            </div>
          </div>
        )}

        {/* History */}
        {history.length > 0 && patterns.length === 0 && !loading && (
          <div className="mt-8">
            <h3 className="text-lg font-semibold text-[oklch(0.45_0.08_350)] mb-4">
              Recent Generations
            </h3>
            <div className="space-y-3">
              {history.map(gen => (
                <button
                  key={gen._id}
                  onClick={() => loadFromHistory(gen)}
                  className="w-full text-left p-4 bg-[oklch(0.99_0.02_50)] rounded-xl hover:shadow-md transition-all border border-[oklch(0.92_0.04_350)]"
                >
                  <div className="flex justify-between items-center">
                    <span className="font-medium text-[oklch(0.40_0.06_350)]">
                      {gen.gender} â€¢ {gen.size} â€¢ {gen.styles?.join(", ") || "Any style"}
                    </span>
                    <span className="text-sm text-[oklch(0.60_0.10_290)]">
                      {gen.patterns?.length} patterns
                    </span>
                  </div>
                </button>
              ))}
            </div>
          </div>
        )}
      </main>

      {/* Footer */}
      <footer className="text-center py-6 text-sm text-[oklch(0.55_0.08_350)]">
        <p>The Knitting Computer â€” From yarn to needles to finished sweater ðŸ§¶</p>
      </footer>
    </div>

    {/* Lightbox rendered outside main container to avoid stacking context issues */}
    {lightboxImage && (
      <Lightbox src={lightboxImage.src} alt={lightboxImage.alt} onClose={closeLightbox} />
    )}
    </>
  );
}

      // === Sign In Screen (for tenant) ===
      function SignInScreen({ subdomain }) {
        return (
          <div className="min-h-screen flex items-center justify-center bg-[oklch(0.95_0.02_250)] p-4">
            <div className="max-w-md text-center p-8 bg-white border-4 border-[#0f172a] shadow-[8px_8px_0px_#0f172a]">
              <h2 className="text-2xl font-bold mb-4">Welcome to {subdomain}</h2>
              <p className="mb-6 text-gray-600">Sign in to access your workspace.</p>
              <div className="flex gap-4 justify-center">
                <SignInButton mode="modal">
                  <button className="px-6 py-3 bg-[#0f172a] text-white font-bold border-4 border-[#0f172a] hover:bg-[#1e293b] transition-colors">
                    Sign In
                  </button>
                </SignInButton>
                <SignUpButton mode="modal">
                  <button className="px-6 py-3 bg-white font-bold border-4 border-[#0f172a] hover:bg-gray-50 transition-colors">
                    Sign Up
                  </button>
                </SignUpButton>
              </div>
            </div>
          </div>
        );
      }

      // === Tenant App Wrapper ===
      // Register tenant when user signs in
      function TenantRegistration({ subdomain, children }) {
        const { user, isLoaded } = useUser();
        const [registrationState, setRegistrationState] = useState('pending'); // 'pending' | 'registering' | 'done'

        useEffect(() => {
          if (!isLoaded || !user) return;

          // If user already has a plan in metadata, skip registration
          if (user.unsafeMetadata?.plan) {
            setRegistrationState('done');
            return;
          }

          // Start registration if not already started
          if (registrationState !== 'pending') return;
          setRegistrationState('registering');

          // Register this subdomain for this user
          const register = async () => {
            try {
              // Register with the worker API
              await fetch(`https://${APP_DOMAIN}/api/tenants/register`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  subdomain,
                  userId: user.id,
                  email: user.primaryEmailAddress?.emailAddress,
                  plan: 'free'
                })
              });

              // Set the plan in user metadata so SubscriptionGate can verify it
              await user.update({
                unsafeMetadata: {
                  ...user.unsafeMetadata,
                  subdomain,
                  plan: 'free',
                  subscriptionStatus: 'active',
                  claimedAt: new Date().toISOString()
                }
              });

              setRegistrationState('done');
            } catch (err) {
              console.error('Failed to register tenant:', err);
              setRegistrationState('done'); // Continue anyway
            }
          };

          register();
        }, [isLoaded, user, subdomain, registrationState]);

        // Show loading while registering new users
        if (!isLoaded || registrationState === 'registering') {
          return (
            <div className="min-h-screen flex items-center justify-center bg-[oklch(0.95_0.02_250)]">
              <div className="text-center">
                <div className="animate-pulse text-lg font-bold mb-2">Setting up your studio...</div>
                <p className="text-gray-500 text-sm">This only takes a moment</p>
              </div>
            </div>
          );
        }

        return children;
      }

      function TenantApp({ subdomain }) {
        return (
          <ClerkProvider publishableKey={CLERK_PUBLISHABLE_KEY} afterSignOutUrl={`https://${APP_DOMAIN}`}>
            <TenantProvider subdomain={subdomain}>
              <SignedIn>
                <TenantRegistration subdomain={subdomain}>
                  <SubscriptionGate>
                    <HiddenMenuWrapper menuContent={<VibesPanel />}>
                      <div className="relative">
                        <div className="fixed top-4 right-4 z-50">
                          <UserButton />
                        </div>
                        <App />
                      </div>
                    </HiddenMenuWrapper>
                  </SubscriptionGate>
                </TenantRegistration>
              </SignedIn>
              <SignedOut>
                <SignInScreen subdomain={subdomain} />
              </SignedOut>
            </TenantProvider>
          </ClerkProvider>
        );
      }

      // === Admin Dashboard ===
      function AdminDashboard() {
        const [tenants, setTenants] = useState([]);
        const [stats, setStats] = useState({ tenantCount: 0, userCount: 0 });
        const [loading, setLoading] = useState(true);
        const [error, setError] = useState(null);
        const { user } = useUser();

        // SECURITY: Do NOT add fallbacks like "|| ADMIN_USER_IDS.length === 0"
        // Empty admin list means NO admin access, not everyone is admin
        const isAdmin = ADMIN_USER_IDS.includes(user?.id);

        // Fetch tenants and stats from worker API
        useEffect(() => {
          if (!isAdmin) return;

          async function fetchData() {
            try {
              const apiBase = `https://${APP_DOMAIN}`;
              const [tenantsRes, statsRes] = await Promise.all([
                fetch(`${apiBase}/api/tenants`),
                fetch(`${apiBase}/api/stats`)
              ]);

              if (tenantsRes.ok) {
                const tenantsData = await tenantsRes.json();
                setTenants(tenantsData.tenants || []);
              }

              if (statsRes.ok) {
                const statsData = await statsRes.json();
                setStats(statsData);
              }
            } catch (err) {
              console.error('Error fetching admin data:', err);
              setError(err.message);
            } finally {
              setLoading(false);
            }
          }

          fetchData();
          // Refresh every 30 seconds
          const interval = setInterval(fetchData, 30000);
          return () => clearInterval(interval);
        }, [isAdmin]);

        if (!isAdmin) {
          return (
            <div className="min-h-screen flex items-center justify-center bg-[oklch(0.95_0.02_250)] p-4">
              <div className="max-w-md text-center p-8 bg-white border-4 border-[#0f172a] shadow-[8px_8px_0px_#0f172a]">
                <h2 className="text-2xl font-bold mb-4">Access Denied</h2>
                <p className="text-gray-600 mb-4">You don't have admin permissions.</p>
                <p className="text-sm text-gray-500">Your user ID: {user?.id}</p>
              </div>
            </div>
          );
        }

        if (loading) {
          return (
            <div className="min-h-screen flex items-center justify-center bg-[oklch(0.97_0.01_250)]">
              <div className="animate-pulse text-lg font-bold">Loading tenants...</div>
            </div>
          );
        }

        const activeTenants = tenants.filter(t => t.status === 'active').length;

        return (
          <div className="min-h-screen bg-[oklch(0.97_0.01_250)] p-4">
            <div className="max-w-6xl mx-auto">
              <header className="flex justify-between items-center mb-8">
                <h1 className="text-3xl font-bold text-[#0f172a]">Admin Dashboard</h1>
                <UserButton />
              </header>

              {error && (
                <div className="mb-6 p-4 bg-red-100 border-4 border-red-500 text-red-700">
                  Error: {error}
                </div>
              )}

              <div className="grid md:grid-cols-4 gap-6 mb-8">
                <div className="p-6 bg-white border-4 border-[#0f172a] shadow-[6px_6px_0px_#0f172a]">
                  <h3 className="text-sm font-bold text-gray-500 mb-2">TOTAL STUDIOS</h3>
                  <p className="text-4xl font-bold">{stats.tenantCount}</p>
                </div>
                <div className="p-6 bg-white border-4 border-[#0f172a] shadow-[6px_6px_0px_oklch(0.6_0.2_145)]">
                  <h3 className="text-sm font-bold text-gray-500 mb-2">TOTAL USERS</h3>
                  <p className="text-4xl font-bold text-blue-600">{stats.userCount}</p>
                </div>
                <div className="p-6 bg-white border-4 border-[#0f172a] shadow-[6px_6px_0px_#0f172a]">
                  <h3 className="text-sm font-bold text-gray-500 mb-2">ACTIVE</h3>
                  <p className="text-4xl font-bold text-green-600">{activeTenants}</p>
                </div>
                <div className="p-6 bg-white border-4 border-[#0f172a] shadow-[6px_6px_0px_#0f172a]">
                  <h3 className="text-sm font-bold text-gray-500 mb-2">PENDING</h3>
                  <p className="text-4xl font-bold text-orange-500">{tenants.length - activeTenants}</p>
                </div>
              </div>

              <div className="bg-white border-4 border-[#0f172a] shadow-[8px_8px_0px_#0f172a]">
                <div className="p-4 border-b-4 border-[#0f172a] bg-[oklch(0.95_0.02_90)]">
                  <h2 className="text-xl font-bold">Tenants</h2>
                </div>
                <div className="divide-y-2 divide-gray-200">
                  {tenants.length === 0 ? (
                    <div className="p-8 text-center text-gray-500">No tenants yet</div>
                  ) : (
                    tenants.map(tenant => (
                      <div key={tenant.id} className="p-4 flex justify-between items-center hover:bg-gray-50">
                        <div className="flex items-center gap-3">
                          {tenant.imageUrl && (
                            <img src={tenant.imageUrl} alt="" className="w-10 h-10 rounded-full border-2 border-[#0f172a]" />
                          )}
                          <div>
                            <p className="font-bold">{tenant.subdomain}.{APP_DOMAIN}</p>
                            <p className="text-sm text-gray-600">{tenant.email}</p>
                          </div>
                        </div>
                        <div className="flex items-center gap-4">
                          <span className={`px-3 py-1 text-sm font-bold ${
                            tenant.status === 'active' ? 'bg-green-100 text-green-700' : 'bg-orange-100 text-orange-700'
                          }`}>
                            {tenant.status}
                          </span>
                          <span className="text-sm text-gray-500">{tenant.plan}</span>
                        </div>
                      </div>
                    ))
                  )}
                </div>
              </div>
            </div>
          </div>
        );
      }

      // === Admin App Wrapper ===
      function AdminApp() {
        return (
          <ClerkProvider publishableKey={CLERK_PUBLISHABLE_KEY} afterSignOutUrl={`https://${APP_DOMAIN}`}>
            <SignedIn>
              <AdminDashboard />
            </SignedIn>
            <SignedOut>
              <div className="min-h-screen flex items-center justify-center bg-[oklch(0.95_0.02_250)] p-4">
                <div className="max-w-md text-center p-8 bg-white border-4 border-[#0f172a] shadow-[8px_8px_0px_#0f172a]">
                  <h2 className="text-2xl font-bold mb-4">Admin Login</h2>
                  <p className="mb-6 text-gray-600">Sign in to access the admin dashboard.</p>
                  <SignInButton mode="modal">
                    <button className="px-6 py-3 bg-[#0f172a] text-white font-bold border-4 border-[#0f172a] hover:bg-[#1e293b] transition-colors">
                      Sign In
                    </button>
                  </SignInButton>
                </div>
              </div>
            </SignedOut>
          </ClerkProvider>
        );
      }

      // === Landing Page Components ===
      function SubdomainPicker({ onSelect }) {
        const [subdomain, setSubdomain] = useState('');
        const [checking, setChecking] = useState(false);
        const [available, setAvailable] = useState(null);
        const [allTenants, setAllTenants] = useState([]);

        // Fetch all tenants once on mount to check availability locally
        useEffect(() => {
          async function fetchTenants() {
            try {
              const response = await fetch(`https://${APP_DOMAIN}/api/tenants`);
              if (response.ok) {
                const data = await response.json();
                setAllTenants(data.tenants || []);
              }
            } catch (err) {
              console.error('Error fetching tenants:', err);
            }
          }
          fetchTenants();
        }, []);

        // Check availability when subdomain changes
        useEffect(() => {
          if (subdomain.length >= 3) {
            setChecking(true);
            const timer = setTimeout(() => {
              const taken = allTenants.some(t => t.subdomain === subdomain);
              // Also check reserved subdomains
              const reserved = ['admin', 'www', 'api', 'app', 'mail', 'smtp', 'ftp'];
              setAvailable(!taken && !reserved.includes(subdomain));
              setChecking(false);
            }, 300);
            return () => clearTimeout(timer);
          } else {
            setAvailable(null);
          }
        }, [subdomain, allTenants]);

        const isValid = /^[a-z0-9-]+$/.test(subdomain) && subdomain.length >= 3 && !subdomain.startsWith('-') && !subdomain.endsWith('-');

        return (
          <div className="space-y-4">
            <label className="block font-bold text-lg">Choose your subdomain:</label>
            <div className="flex items-center gap-2 p-4 bg-[oklch(0.95_0.02_90)] border-4 border-[#0f172a]">
              <input
                type="text"
                value={subdomain}
                onChange={(e) => setSubdomain(e.target.value.toLowerCase().replace(/[^a-z0-9-]/g, ''))}
                placeholder="your-name"
                className="flex-1 px-4 py-3 border-2 border-[#0f172a] bg-white font-mono text-lg focus:outline-none focus:ring-2 focus:ring-[oklch(0.6_0.2_145)]"
                maxLength={32}
              />
              <span className="font-mono text-gray-600 text-lg">.{APP_DOMAIN}</span>
            </div>

            {subdomain.length > 0 && (
              <div className="text-sm font-medium">
                {checking && <span className="text-gray-500">Checking availability...</span>}
                {!checking && available === true && isValid && (
                  <span className="text-green-600">&#10003; {subdomain}.{APP_DOMAIN} is available!</span>
                )}
                {!checking && available === false && (
                  <span className="text-red-600">&#10007; Already taken - try another name</span>
                )}
                {!isValid && subdomain.length > 0 && (
                  <span className="text-orange-600">Use lowercase letters, numbers, and dashes (min 3 chars, no leading/trailing dashes)</span>
                )}
              </div>
            )}

            {available && isValid && (
              <button
                onClick={() => onSelect(subdomain)}
                className="w-full px-6 py-4 bg-[oklch(0.6_0.2_145)] text-white text-lg font-bold border-4 border-[#0f172a] shadow-[6px_6px_0px_#0f172a] hover:shadow-[4px_4px_0px_#0f172a] hover:translate-x-[2px] hover:translate-y-[2px] transition-all"
              >
                Claim {subdomain}.{APP_DOMAIN} &rarr;
              </button>
            )}
          </div>
        );
      }

      function PricingCard({ title, price, interval, features, popular, onSelect }) {
        return (
          <div className={`p-6 bg-white border-4 border-[#0f172a] transition-all ${
            popular
              ? 'shadow-[8px_8px_0px_oklch(0.6_0.2_145)] hover:shadow-[6px_6px_0px_oklch(0.6_0.2_145)]'
              : 'shadow-[6px_6px_0px_#0f172a] hover:shadow-[4px_4px_0px_#0f172a]'
          }`}>
            {popular && (
              <div className="mb-4 -mt-6 -mx-6 px-4 py-2 bg-[oklch(0.6_0.2_145)] text-white text-center font-bold border-b-4 border-[#0f172a]">
                MOST POPULAR
              </div>
            )}
            <h3 className="text-2xl font-bold mb-2">{title}</h3>
            <div className="mb-6">
              <span className="text-5xl font-bold">{price}</span>
              <span className="text-gray-600 text-lg">/{interval}</span>
            </div>
            <ul className="mb-8 space-y-3">
              {features.map((feature, i) => (
                <li key={i} className="flex items-start gap-3">
                  <span className="text-green-600 font-bold text-xl mt-0.5">&#10003;</span>
                  <span className="text-gray-700">{feature}</span>
                </li>
              ))}
            </ul>
            <button
              onClick={onSelect}
              className={`w-full px-6 py-4 font-bold text-lg border-4 border-[#0f172a] transition-all ${
                popular
                  ? 'bg-[oklch(0.6_0.2_145)] text-white shadow-[4px_4px_0px_#0f172a] hover:shadow-[2px_2px_0px_#0f172a] hover:translate-x-[2px] hover:translate-y-[2px]'
                  : 'bg-[oklch(0.95_0.02_90)] hover:bg-[oklch(0.9_0.02_90)]'
              }`}
            >
              Get Started
            </button>
          </div>
        );
      }

      function Hero() {
        const formattedName = APP_NAME.replace(/-/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
        return (
          <div className="text-center py-20 px-4">
            <h1 className="text-5xl md:text-7xl font-bold mb-6 tracking-tight text-[#0f172a]">
              {formattedName}
            </h1>
            <p className="text-xl md:text-2xl text-gray-600 max-w-2xl mx-auto mb-8">
              {APP_TAGLINE}
            </p>
            <a
              href="#pricing"
              className="inline-block px-8 py-4 bg-[#0f172a] text-white font-bold text-lg border-4 border-[#0f172a] shadow-[4px_4px_0px_oklch(0.6_0.2_145)] hover:shadow-[2px_2px_0px_oklch(0.6_0.2_145)] hover:translate-x-[2px] hover:translate-y-[2px] transition-all"
            >
              See Plans &rarr;
            </a>
          </div>
        );
      }

      function CheckoutFlow({ plan, onBack }) {
        const { user } = useUser();
        const [saving, setSaving] = useState(false);

        const handleSubdomainSelect = async (subdomain) => {
          if (user) {
            setSaving(true);
            try {
              // Store subdomain in Clerk user's unsafeMetadata (writable from frontend)
              // Note: unsafeMetadata is readable by the user, use for non-sensitive data
              await user.update({
                unsafeMetadata: {
                  ...user.unsafeMetadata,
                  subdomain,
                  plan,
                  subscriptionStatus: 'active',
                  claimedAt: new Date().toISOString()
                }
              });
              // Redirect to their new subdomain
              window.location.href = `https://${subdomain}.${APP_DOMAIN}`;
            } catch (err) {
              console.error('Error saving subdomain:', err);
              setSaving(false);
              alert('Failed to claim subdomain. Please try again.');
            }
          }
        };

        return (
          <section className="py-16 px-4 max-w-xl mx-auto">
            <div className="p-8 bg-white border-4 border-[#0f172a] shadow-[8px_8px_0px_#0f172a]">
              <button onClick={onBack} className="mb-6 text-gray-600 hover:text-[#0f172a] font-medium">
                &larr; Back to plans
              </button>
              <h3 className="text-2xl font-bold mb-2">{plan === 'yearly' ? 'Yearly' : 'Monthly'} Plan</h3>
              <p className="text-gray-600 mb-6">{plan === 'yearly' ? YEARLY_PRICE : MONTHLY_PRICE}/{plan === 'yearly' ? 'year' : 'month'}</p>

              <SignedOut>
                <p className="mb-6 text-gray-700">Create an account to claim your subdomain:</p>
                <div className="flex gap-4">
                  <SignUpButton mode="modal">
                    <button className="flex-1 px-6 py-3 bg-[#0f172a] text-white font-bold border-4 border-[#0f172a]">Create Account</button>
                  </SignUpButton>
                  <SignInButton mode="modal">
                    <button className="flex-1 px-6 py-3 bg-white font-bold border-4 border-[#0f172a]">Sign In</button>
                  </SignInButton>
                </div>
              </SignedOut>

              <SignedIn>
                <SubdomainPicker onSelect={handleSubdomainSelect} />
              </SignedIn>
            </div>
          </section>
        );
      }

      function LandingPage() {
        const [subdomain, setSubdomain] = useState("");
        const [isValid, setIsValid] = useState(false);

        const validateSubdomain = (value) => {
          const cleaned = value.toLowerCase().replace(/[^a-z0-9-]/g, '');
          setSubdomain(cleaned);
          setIsValid(cleaned.length >= 3 && cleaned.length <= 30 && /^[a-z]/.test(cleaned));
        };

        const handleClaim = () => {
          if (isValid) window.location.href = `https://${subdomain}.${APP_DOMAIN}`;
        };

        return (
          <div className="min-h-screen bg-[oklch(0.97_0.02_350)]">
            <header className="bg-[linear-gradient(180deg_in_oklch,oklch(0.82_0.12_330),oklch(0.88_0.10_10))] pt-12 pb-24 px-4 relative overflow-hidden">
              <div className="absolute inset-0 opacity-20">
                <div className="absolute top-4 left-[10%] text-6xl">ðŸ§¶</div>
                <div className="absolute top-12 right-[15%] text-4xl">ðŸª¡</div>
                <div className="absolute bottom-8 left-[20%] text-5xl">ðŸ§µ</div>
              </div>
              <div className="max-w-4xl mx-auto text-center relative">
                <img src="logo.png" alt="The Knitting Computer" className="w-32 h-32 object-contain mx-auto mb-4 drop-shadow-lg" />
                <h1 className="text-4xl md:text-5xl font-bold tracking-tight text-[oklch(0.35_0.12_350)] mb-4">The Knitting Computer</h1>
                <p className="text-xl text-[oklch(0.45_0.10_350)] mb-8 max-w-2xl mx-auto">AI-powered knitting pattern designer. Generate complete, production-ready sweater patterns.</p>
                <div className="bg-white/80 backdrop-blur rounded-2xl p-6 max-w-md mx-auto shadow-xl border border-[oklch(0.92_0.04_350)]">
                  <label className="block text-sm font-medium text-[oklch(0.40_0.08_350)] mb-2">Claim your knitting studio</label>
                  <div className="flex items-stretch mb-4">
                    <input type="text" value={subdomain} onChange={(e) => validateSubdomain(e.target.value)} placeholder="yourname" className="min-w-0 flex-1 px-4 py-3 rounded-l-xl border-2 border-r-0 border-[oklch(0.88_0.04_350)] focus:border-[oklch(0.60_0.12_350)] focus:outline-none text-base leading-6" />
                    <span className="shrink-0 flex items-center px-3 py-3 bg-[oklch(0.94_0.03_350)] rounded-r-xl border-2 border-l-0 border-[oklch(0.88_0.04_350)] text-[oklch(0.50_0.06_350)] text-sm leading-6 whitespace-nowrap">.{APP_DOMAIN}</span>
                  </div>
                  <button onClick={handleClaim} disabled={!isValid} className="w-full py-3 rounded-xl bg-[linear-gradient(135deg_in_oklch,oklch(0.60_0.12_350),oklch(0.55_0.12_290))] text-white font-bold text-lg hover:opacity-90 disabled:opacity-50 transition-opacity">Get Started Free</button>
                </div>
              </div>
            </header>
            <section className="py-16 px-4">
              <div className="max-w-5xl mx-auto">
                <h2 className="text-3xl font-bold text-center text-[oklch(0.40_0.10_350)] mb-12">Everything You Need to Design Sweaters</h2>
                <div className="grid md:grid-cols-3 gap-8">
                  <div className="bg-white rounded-2xl p-6 shadow-lg border border-[oklch(0.92_0.04_350)]">
                    <div className="text-4xl mb-4">ðŸŽ¨</div>
                    <h3 className="text-xl font-bold text-[oklch(0.40_0.10_350)] mb-2">AI Pattern Generation</h3>
                    <p className="text-[oklch(0.55_0.08_350)]">Complete patterns with gauge, sizing, and instructions.</p>
                  </div>
                  <div className="bg-white rounded-2xl p-6 shadow-lg border border-[oklch(0.92_0.04_350)]">
                    <div className="text-4xl mb-4">ðŸ–¼ï¸</div>
                    <h3 className="text-xl font-bold text-[oklch(0.40_0.10_350)] mb-2">Visual Previews</h3>
                    <p className="text-[oklch(0.55_0.08_350)]">AI-generated images of your designs before knitting.</p>
                  </div>
                  <div className="bg-white rounded-2xl p-6 shadow-lg border border-[oklch(0.92_0.04_350)]">
                    <div className="text-4xl mb-4">ðŸ“š</div>
                    <h3 className="text-xl font-bold text-[oklch(0.40_0.10_350)] mb-2">Pattern Library</h3>
                    <p className="text-[oklch(0.55_0.08_350)]">Save and organize all your patterns.</p>
                  </div>
                </div>
              </div>
            </section>
            <footer className="py-8 px-4 text-center text-sm text-[oklch(0.55_0.08_350)]">
              <p>The Knitting Computer â€” From yarn to needles to finished sweater ðŸ§¶</p>
            </footer>
          </div>
        );
      }

      // === Main Router ===
      function AppRouter() {
        if (routeInfo.route === 'admin') {
          return <AdminApp />;
        }
        if (routeInfo.route === 'tenant') {
          return <TenantApp subdomain={routeInfo.subdomain} />;
        }
        return <LandingPage />;
      }

      // Render
      const rootElement = document.getElementById("container");
      ReactDOMClient.createRoot(rootElement).render(<AppRouter />);
    </script>
  </body>
</html>
